<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Name Prospector</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-color: #58a6ff;
            --accent-hover: #4493e0;
            --success-color: #3fb950;
            --success-hover: #2ea043;
            --error-color: #f85149;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .main-container {
            background: rgba(33, 38, 45, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin: 2rem auto;
            max-width: 1000px;
        }

        .header-section {
            background: linear-gradient(135deg, var(--accent-color) 0%, #7c3aed 100%);
            border-radius: 16px 16px 0 0;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            opacity: 0.3;
        }

        .header-section h1 {
            margin: 0;
            font-weight: 500;
            font-size: 2.5rem;
            color: white;
            position: relative;
            z-index: 2;
        }

        .header-section .subtitle {
            margin-top: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            font-weight: 300;
            position: relative;
            z-index: 2;
        }

        .form-section {
            padding: 2rem;
        }

        .form-control, .form-select {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bg-tertiary);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(88, 166, 255, 0.25);
            color: var(--text-primary);
        }

        .form-label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, #4493e0 100%);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            padding: 0.75rem 2rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-hover) 0%, #3a7bc8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #2ea043 100%);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            padding: 0.75rem 2rem;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, var(--success-hover) 0%, #238636 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(63, 185, 80, 0.3);
        }

        .error-message {
            color: var(--error-color);
            font-weight: 500;
            text-align: center;
            margin: 1rem 0;
            padding: 0.5rem;
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.2);
            border-radius: 8px;
        }

        .input-error {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 0.2rem rgba(248, 81, 73, 0.25) !important;
        }

        .loading-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }

        .progress {
            height: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent-color) 0%, #7c3aed 100%);
            border-radius: 4px;
        }

        .results-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem auto;
            max-height: 400px;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .results-header h3 {
            margin: 0;
            color: var(--accent-color);
            font-weight: 600;
        }

        .name-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .name-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .name-item:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .custom-notice {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--error-color);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-row > div {
            flex: 1;
            min-width: 200px;
        }

        .form-row .gender-group {
            flex: 0.4;
            min-width: 120px;
        }

        /* Custom scrollbar */
        .name-grid::-webkit-scrollbar {
            width: 6px;
        }

        .name-grid::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .name-grid::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }

        .name-grid::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
            }
            
            .header-section h1 {
                font-size: 2rem;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-row > div {
                min-width: auto;
            }
            
            .name-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        .card, .form-control, .form-section, .header-section, .custom-names-container, .main-container {
            border-radius: 0 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header Section -->
            <div class="header-section">
                <h1>Fantasy Name Prospector</h1>
                <p class="subtitle">Generate new magical names from various cultures and custom datasets</p>
            </div>

            <!-- Main Form Section -->
            <div class="form-section">
                <form method="POST" action="/generate" id="name-generator-form">
                    <!-- Model and Gender Selection -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="model" class="form-label">Select a Model</label>
                            <select id="model" name="model" class="form-select">
                                <option value="classic_american" {% if selected_model == 'classic_american' %}selected{% endif %}>American (Classic)</option>
                                <option value="new_age_american" {% if selected_model == 'new_age_american' %}selected{% endif %}>American (New Age)</option>
                                <option value="arabic" {% if selected_model == 'arabic' %}selected{% endif %}>Arabic</option>
                                <option value="aztec" {% if selected_model == 'aztec' %}selected{% endif %}>Aztec</option>
                                <option value="chinese" {% if selected_model == 'chinese' %}selected{% endif %}>Chinese</option>
                                <option value="french" {% if selected_model == 'french' %}selected{% endif %}>French</option>
                                <option value="german" {% if selected_model == 'german' %}selected{% endif %}>German</option>
                                <option value="greek" {% if selected_model == 'greek' %}selected{% endif %}>Greek</option>
                                <option value="russian" {% if selected_model == 'russian' %}selected{% endif %}>Russian</option>
                                <option value="custom" {% if selected_model == 'custom' %}selected{% endif %}>CUSTOM</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="gender" class="form-label">Gender</label>
                            <select id="gender" name="gender" class="form-select">
                                <option value="neutral" selected>Neutral</option>
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Names Input -->
                    <div id="custom-names-container" class="mb-4" style="display: none;">
                        <label for="custom_names" class="form-label">Enter Your Custom Names</label>
                        <textarea id="custom_names" name="custom_names" rows="8" class="form-control" 
                                  placeholder="Enter names here...&#10;one per line...&#10;like this..."></textarea>
                        <div id="custom-notice" class="custom-notice" style="display: none;">
                            <i class="bi bi-info-circle"></i> <strong>Note:</strong> Custom names take longer to process as the AI needs to learn from your examples.
                        </div>
                    </div>

                    <!-- Parameters Row -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <label for="temperature" class="form-label">Temperature</label>
                            <input type="number" id="temperature" name="temperature" class="form-control" 
                                   placeholder="0.0 - 5.0" min="0.0" max="5.0" step="0.1" value="1.0" required>
                            <div class="form-text">Higher = more creative/messy</div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <label for="prefix" class="form-label">Prefix <span class="text-muted">(Optional)</span></label>
                            <input type="text" id="prefix" name="prefix" class="form-control" 
                                   placeholder="A, Aa, Aaa..." value="{{ prefix }}">
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <label for="length" class="form-label">Length <span class="text-muted">(Optional)</span></label>
                            <input type="number" id="length" name="length" class="form-control" 
                                   placeholder="default: 6" min="1" value="{{ length }}">
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <label for="count" class="form-label">Count</label>
                            <select id="count" name="count" class="form-select">
                                <option value="1">1</option>
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="error-message" class="error-message" style="display:none;">
                        <i class="bi bi-exclamation-triangle"></i> Prefix text cannot be longer than name length.
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center">
                        <button id="generate-button" type="submit" class="btn btn-primary btn-lg me-2">
                            <i class="bi bi-play-fill"></i> Generate Names
                        </button>
                        <button id="train-button" type="submit" class="btn btn-success btn-lg" style="display:none;">
                            <i class="bi bi-cpu"></i> Train Model
                        </button>
                    </div>
                </form>

                <!-- Loading Section -->
                <div id="loading" class="loading-section" style="display:none;">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="spinner-border text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span id="loading-text" class="fs-5">Preparing...</span>
                    </div>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generated Names Results -->
        {% if generated_names %}
        <div class="d-flex justify-content-center">
            <div class="main-container results-section" style="max-width: 900px; width: 100%;">
                <div class="results-header">
                    <h3>Generated Names</h3>
                    <span class="badge bg-primary">{{ generated_names|length }} names</span>
                </div>
                <div class="name-grid" id="generated-name-grid">
                    {% for name in generated_names %}
                    <div class="name-item">{{ name }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>

    <script>
        // Main form
        const form = document.getElementById('name-generator-form');

        // References to the form fields for dynamic error message
        const prefixInput = document.getElementById('prefix');
        const lengthInput = document.getElementById('length');
        const errorMessage = document.getElementById('error-message');

        // References to loading elements
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');

        // References to the form fields for dynamic type box
        const modelSelect = document.getElementById('model');
        const customNamesContainer = document.getElementById('custom-names-container');
        const customNotice = document.getElementById('custom-notice');
        const customNamesText = document.getElementById('custom_names');

        const trainButton = document.getElementById('train-button');
        const generateButton = document.getElementById('generate-button');

        // Track the last custom text that was successfully trained
        let lastTrainedCustomText = '';

        // Add this function after your existing variable declarations
        function updateLengthPlaceholder() {
            const selectedModel = modelSelect.value;

            if (selectedModel === 'custom') {
                lengthInput.placeholder = 'default: 6';
                return;
            }

            // Fetch avg_length for selected model
            fetch(`/get_model_avg_length?model=${selectedModel}`)
                .then(response => response.json())
                .then(data => {
                    const prefix = data.is_default ? 'default: ' : 'average: ';
                    lengthInput.placeholder = prefix + data.avg_length;
                })
                .catch(error => {
                    console.log('Error fetching avg_length:', error);
                    lengthInput.placeholder = 'default: 6';
                });
        }

        // Add event listener for model selection changes
        modelSelect.addEventListener('change', function() {
            updateLengthPlaceholder();
        });

        // Update placeholder on page load
        updateLengthPlaceholder();

        // Function to update button visibility based on model and training status
        function updateButtonVisibility() {
            if (modelSelect.value === 'custom') {
                const currentCustomText = customNamesText.value.trim();
                
                if (!currentCustomText) {
                    trainButton.style.display = 'inline-block';
                    trainButton.disabled = true;
                    generateButton.style.display = 'none';
                } else if (currentCustomText === lastTrainedCustomText && lastTrainedCustomText !== '') {
                    trainButton.style.display = 'none';
                    generateButton.style.display = 'inline-block';
                    generateButton.disabled = false;
                } else {
                    trainButton.disabled = false;
                    checkIfModelExistsDebounced();
                }
            } else {
                trainButton.style.display = 'none';
                generateButton.style.display = 'inline-block';
                generateButton.disabled = false;
            }
        }

        // Function to toggle the visibility of the custom names input field
        modelSelect.addEventListener('change', function() {
            if (modelSelect.value === 'custom') {
                customNamesContainer.style.display = 'block';
                customNotice.style.display = 'block';
            } else {
                customNamesContainer.style.display = 'none';
                customNotice.style.display = 'none';
            }
            updateButtonVisibility();
        });

        // Listen for changes in custom names text
        customNamesText.addEventListener('input', function() {
            updateButtonVisibility();
        });

        // Trigger the change event to ensure the correct initial state
        modelSelect.dispatchEvent(new Event('change'));

        // Add event listener to validate inputs when the form is submitted
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // Validate inputs
            const prefixText = prefixInput.value;
            const nameLength = parseInt(lengthInput.value);
            const customNamesTextValue = customNamesText.value.trim();

            if (prefixText.length > nameLength) {
                errorMessage.style.display = 'block';
                prefixInput.classList.add('input-error');
                lengthInput.classList.add('input-error');
                return;
            } else {
                errorMessage.style.display = 'none';
                prefixInput.classList.remove('input-error');
                lengthInput.classList.remove('input-error');
            }

            // Show loading elements
            loadingDiv.style.display = 'block';
            loadingText.textContent = 'Preparing...';
            progressBar.style.width = '0%';
        
            // Remove any previous results
            const existingResults = document.querySelector('.results-section');
            if (existingResults) {
                existingResults.remove();
            }
        
            // Get form data
            const formData = new FormData(form);

            // Create fetch request to stream_progress endpoint
            fetch('/stream_progress', {
                method: 'POST',
                body: formData
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function processStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log('Stream complete');
                            return;
                        }
                        
                        const text = decoder.decode(value);
                        const lines = text.split('\n\n');
                        
                        lines.forEach(line => {
                            if (line.startsWith('data:')) {
                                try {
                                    const jsonData = JSON.parse(line.substring(5).trim());
                                    console.log("Received event data:", jsonData);

                                    // Update loading information for ALL event types
                                    if (jsonData.message) {
                                        loadingText.textContent = jsonData.message;
                                    }
                        
                                    if (jsonData.progress !== undefined) {
                                        progressBar.style.width = jsonData.progress + '%';
                                    }
                        
                                    // Handle different event types
                                    switch(jsonData.type) {
                                        case 'preparing':
                                        case 'loading':
                                        case 'training':
                                            loadingDiv.style.display = 'block';
                                            break;
                                            
                                        case 'generating':
                                            loadingDiv.style.display = 'block';
                                            
                                            // Create results container if it doesn't exist
                                            let resultsContainer = document.querySelector('.results-section');
                                            if (!resultsContainer) {
                                                resultsContainer = document.createElement('div');
                                                resultsContainer.className = 'main-container results-section';
                                                resultsContainer.innerHTML = `
                                                    <div class="results-header">
                                                        <h3>Generated Names</h3>
                                                        <span class="badge bg-primary" id="name-count">0 names</span>
                                                    </div>
                                                    <div class="name-grid" id="generated-name-grid">
                                                    </div>
                                                `;
                                                document.querySelector('.container-fluid').appendChild(resultsContainer);
                                            }
                                            
                                            // Add new name if provided
                                            if (jsonData.name) {
                                                const nameGrid = document.getElementById('generated-name-grid');
                                                const nameItem = document.createElement('div');
                                                nameItem.className = 'name-item';
                                                nameItem.textContent = jsonData.name;
                                                
                                                // Add click to copy functionality
                                                nameItem.addEventListener('click', function() {
                                                    navigator.clipboard.writeText(jsonData.name).then(() => {
                                                        // Brief visual feedback
                                                        const originalBg = nameItem.style.backgroundColor;
                                                        nameItem.style.backgroundColor = '#28a745';
                                                        setTimeout(() => {
                                                            nameItem.style.backgroundColor = originalBg;
                                                        }, 200);
                                                    });
                                                });
                                                
                                                nameGrid.appendChild(nameItem);
                                                
                                                // Update count
                                                const countBadge = document.getElementById('name-count');
                                                if (countBadge) {
                                                    const currentCount = nameGrid.children.length;
                                                    countBadge.textContent = `${currentCount} names`;
                                                }
                                            }
                                            break;
                                            
                                        case 'training_complete':
                                            loadingText.textContent = "Training complete! Starting name generation...";
                                            if (modelSelect.value === 'custom') {
                                                lastTrainedCustomText = customNamesText.value.trim();
                                                trainButton.style.display = 'none';
                                                generateButton.style.display = 'inline-block';
                                            }
                                            break;
                                
                                        case 'complete':
                                            loadingDiv.style.display = 'none';
                                            
                                            // If we haven't created the results div yet
                                            let finalResultsContainer = document.querySelector('.results-section');
                                            if (!finalResultsContainer) {
                                                finalResultsContainer = document.createElement('div');
                                                finalResultsContainer.className = 'main-container results-section';
                                                finalResultsContainer.innerHTML = `
                                                    <div class="results-header">
                                                        <h3>Generated Names</h3>
                                                        <span class="badge bg-primary">${jsonData.names.length} names</span>
                                                    </div>
                                                    <div class="name-grid">
                                                        ${jsonData.names.map(name => `<div class="name-item" onclick="navigator.clipboard.writeText('${name}')">${name}</div>`).join('')}
                                                    </div>
                                                `;
                                                document.querySelector('.container-fluid').appendChild(finalResultsContainer);
                                            }
                                            
                                            if (modelSelect.value === 'custom' && trainButton.style.display !== 'none') {
                                                lastTrainedCustomText = customNamesText.value.trim();
                                                updateButtonVisibility();
                                            }
                                            break;
                                
                                        case 'error':
                                            loadingText.textContent = "Error: " + jsonData.message;
                                            loadingDiv.style.display = 'block';
                                            break;
                                    }
                                } catch (e) {
                                    console.error('Error parsing SSE data:', e);
                                }
                            }
                        });
                        
                        return processStream();
                    });
                }
                
                return processStream();
            }).catch(error => {
                console.error('Fetch error:', error);
                loadingText.textContent = 'Error: ' + error.message;
            });
        });

        // Function for finding MD5 hash
        function hashCustomNames(text) {
            const hashHex = md5(text);
            return `custom_${hashHex}`;
        }

        let debounceTimeout = null;

        function checkIfModelExistsDebounced() {
            console.log("Running check for model existence");
            if (debounceTimeout) {
                clearTimeout(debounceTimeout);
            }

            debounceTimeout = setTimeout(() => {
                const model = modelSelect.value;
                const customNamesTextValue = customNamesText.value.trim();

                if (model !== 'custom' || !customNamesTextValue) {
                    return;
                }

                const hashedModelName = hashCustomNames(customNamesTextValue);
                console.log("Expected model filename:", hashedModelName);

                fetch('/check_model_exists?model=' + encodeURIComponent(hashedModelName))
                    .then(response => response.json())
                    .then(data => {
                        const modelExists = data.exists;

                        if (modelExists) {
                            lastTrainedCustomText = customNamesTextValue;
                            trainButton.style.display = 'none';
                            generateButton.style.display = 'inline-block';
                        } else {
                            trainButton.style.display = 'inline-block';
                            generateButton.style.display = 'none';
                        }
                    })
                    .catch(err => {
                        console.error("Error checking model:", err);
                        trainButton.style.display = 'inline-block';
                        generateButton.style.display = 'none';
                    });
            }, 500);
        }

        // Run initial check
        checkIfModelExistsDebounced();
    </script>
</body>
</html>